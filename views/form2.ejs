<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form 2 - RSVP Application</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body class="bg-white">
<div class="min-h-screen bg-white">
    <div class="max-w-3xl mx-auto px-6">
        <!-- Banner -->
        <div class="mt-8 rounded-t-lg overflow-hidden">
            <img src="/images/banner.jpg" alt="Banner" class="w-full h-auto">
        </div>

        <!-- Main Content -->
        <div class="py-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2 text-center">香港賽馬會呈獻：「馬到功成耀香江」馬年煙花滙演</h2>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2 text-center">The Hong Kong Jockey Club Presents: </h2>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2 text-center">"Prosperity Gallops Across Hong Kong"</h2>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2 text-center">Year of the Horse Fireworks Display </h2>
            <p class="text-gray-600 mb-6">請填寫以下資料完成活動報名
                Please fill in the following information to complete event registration</p>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                <%= error %>
            </div>
        <% } %>

        <form method="POST" action="/form2" id="form2" class="bg-white">
            <!-- Main Attendee Information -->
            <div class="mb-8">
                <div class="space-y-6">
                    <!-- Surname -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *姓(英文) / Surname in English <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="surname" required
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Given Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *名(英文) / Given Name in English <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="givenName" required
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Chinese Name -->
                    <div>
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    姓(中文) / Surname in Chinese
                                </label>
                                <input type="text" name="chineseSurname"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    名(中文) / Given Name in Chinese
                                </label>
                                <input type="text" name="chineseGivenName"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Title of Respect -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *稱謂 / Title of Respect <span class="text-red-500">*</span>
                        </label>
                        <select name="titleOfRespect" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Please select ---</option>
                            <option value="Mr">先生 / Mr</option>
                            <option value="Mrs">太太 / Mrs</option>
                            <option value="Ms">女士 / Ms</option>
                            <option value="Miss">小姐 / Miss</option>
                        </select>
                    </div>

                    <!-- Company / Organization -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            公司 / 機構 / Company / Organization
                        </label>
                        <input type="text" name="company"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Title -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            職銜 / Title
                        </label>
                        <input type="text" name="title"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Mobile Country Code and Mobile -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            手提電話 / Mobile 
                        </label>
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-3">
                                <select name="mobileCountryCode"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <%- include('partials/country-codes') %>
                                </select>
                            </div>
                            <div class="col-span-9">
                                <input type="tel" name="mobile"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *#電子郵件 / Email (以提供活動入場二維碼) (For generating admission QR code) <span class="text-red-500">*</span>
                        </label>
                        <input type="email" name="email" required
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Attend -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            您會否出席馬年煙花匯演? Will you attend "Year of the Horse Fireworks Display"? <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-6">
                            <label class="flex items-center">
                                <input type="radio" name="attend" value="Yes" required class="mr-2" onchange="toggleAttendSections()">
                                <span>出席 / Yes</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="attend" value="No" required class="mr-2" onchange="toggleAttendSections()">
                                <span>不出席 / No</span>
                            </label>
                        </div>
                    </div>

                    <!-- Food Allergy -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            食物敏感(如有請註明) / Food Allergy (Please specify if any)
                        </label>
                        <input type="text" name="foodAllergy"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Spouse Information (Yellow Background) -->
            <div id="spouseSection" class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">攜眷 / With Spouse</h3>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        攜眷 / With Spouse
                    </label>
                    <div class="flex gap-6">
                        <label class="flex items-center">
                            <input type="radio" name="withSpouse" value="Yes" required class="mr-2" onchange="toggleSpouseFields()">
                            <span>是 / Yes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="withSpouse" value="No" required class="mr-2" onchange="toggleSpouseFields()">
                            <span>否 / No</span>
                        </label>
                    </div>
                </div>

                <div id="spouseFields" class="space-y-6 hidden">
                    <!-- Spouse Surname -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *姓(英文) / Surname in English <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="spouseSurname"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Spouse Given Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *名(英文) / Given Name in English <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="spouseGivenName"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Spouse Chinese Name -->
                    <div>
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    姓(中文) / Surname in Chinese
                                </label>
                                <input type="text" name="spouseChineseSurname"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    名(中文) / Given Name in Chinese
                                </label>
                                <input type="text" name="spouseChineseGivenName"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Spouse Title of Respect -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *稱謂 / Title of Respect <span class="text-red-500">*</span>
                        </label>
                        <select name="spouseTitleOfRespect"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">--- Please select ---</option>
                            <option value="Mr">先生 / Mr</option>
                            <option value="Mrs">太太 / Mrs</option>
                            <option value="Ms">女士 / Ms</option>
                            <option value="Miss">小姐 / Miss</option>
                        </select>
                    </div>

                    <!-- Spouse Mobile Country Code and Mobile -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            手提電話 / Mobile
                        </label>
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-3">
                                <select name="spouseMobileCountryCode"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <%- include('partials/country-codes') %>
                                </select>
                            </div>
                            <div class="col-span-9">
                                <input type="tel" name="spouseMobile"
                                    placeholder="fill in the blank"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Spouse Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            *#電子郵件 / Email (以提供活動入場二維碼) (For generating admission QR code) <span class="text-red-500">*</span>
                        </label>
                        <input type="email" name="spouseEmail"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Spouse Food Allergy -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            食物敏感(如有請註明) / Food Allergy (Please specify if any)
                        </label>
                        <input type="text" name="spouseFoodAllergy"
                            placeholder="fill in the blank"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Important Notes -->
            <div class="mb-6 text-sm text-gray-600">
                <p>*必須提供 / Items must be provided</p>
                <p>#所有出席者的電郵地址必須各不相同 / All attendees must register with distinct email addresses</p>
            </div>

            <!-- Privacy Policy -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg text-justify">
                <div class="mb-4">
                    <p class="text-sm text-gray-700 mb-2">
                        By submitting this form, you are deemed to have agreed that this platform and The Hong Kong Jockey Club may collect and use the relevant personal data, and have read and accepted The Hong Kong Jockey Club's Privacy Policy Statement available at 
                        <a href="https://www.hkjc.com/home/english/corporate/corp_privacy.aspx" target="_blank" class="text-blue-600 hover:underline">https://www.hkjc.com/home/english/corporate/corp_privacy.aspx</a>. 
                        If you provide any personal data of any third party, you are deemed to have obtained authorisation to provide and allow this platform and The Hong Kong Jockey Club to collect and use the relevant personal data. Personal data may also be disclosed to third party services providers of this platform and The Hong Kong Jockey Club for the purposes of organising the event.
                    </p>
                    <p class="text-sm text-gray-700">
                        如閣下回覆此表格，將被視為已同意本平台及香港賽馬會收集及使用有關個人資料，並已閱讀及同意香港賽馬會載於下述網址的私隱條款: 
                        <a href="https://www.hkjc.com/home/chinese/corporate/corp_privacy.aspx" target="_blank" class="text-blue-600 hover:underline">https://www.hkjc.com/home/chinese/corporate/corp_privacy.aspx</a>. 
                        如閣下提供他人的個人資料，閣下將被視為已取得足夠授權提供及容許本平台及香港賽馬會收集及使用有關個人資料。個人資料可能會提供予本平台及香港賽馬會的第三方服務供應商，以作活動安排之用。
                    </p>
                </div>
                <div class="flex items-start">
                    <input type="checkbox" name="privacyConsent" id="privacyConsent" required
                        class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="privacyConsent" class="text-sm text-gray-700">
                        我已閱讀並同意上述私隱政策 I have read and accepted the above privacy policy. <span class="text-red-500">*</span>
                    </label>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4 justify-end">
                <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    提交 Submit
                </button>
            </div>
        </form>
        </div>
    </div>
</div>

<script>
function toggleAttendSections() {
    const attend = document.querySelector('input[name="attend"]:checked');
    const spouseSection = document.getElementById('spouseSection');
    
    if (attend && attend.value === 'Yes') {
        spouseSection.classList.remove('hidden');
    } else {
        spouseSection.classList.add('hidden');
        // 重置攜眷選項
        document.querySelectorAll('input[name="withSpouse"]').forEach(radio => {
            radio.checked = false;
        });
        toggleSpouseFields();
    }
}

function toggleSpouseFields() {
    const withSpouse = document.querySelector('input[name="withSpouse"]:checked');
    const spouseFields = document.getElementById('spouseFields');
    const spouseInputs = spouseFields.querySelectorAll('input[required], select[required]');
    
    if (withSpouse && withSpouse.value === 'Yes') {
        spouseFields.classList.remove('hidden');
        spouseInputs.forEach(input => {
            input.setAttribute('required', 'required');
        });
    } else {
        spouseFields.classList.add('hidden');
        spouseInputs.forEach(input => {
            input.removeAttribute('required');
            input.value = '';
        });
    }
}

// 表單提交前驗證和 AJAX 提交
document.getElementById('form2').addEventListener('submit', async function(e) {
    e.preventDefault(); // 總是阻止預設提交
    
    const form = this;
    const attend = document.querySelector('input[name="attend"]:checked');
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    
    // 隱藏之前的錯誤訊息
    const errorDiv = document.querySelector('.bg-red-100');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // 只有選擇出席時才驗證攜眷資料
    if (attend && attend.value === 'Yes') {
        const withSpouse = document.querySelector('input[name="withSpouse"]:checked');
        if (withSpouse && withSpouse.value === 'Yes') {
            const spouseFields = document.getElementById('spouseFields');
            const requiredFields = spouseFields.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500');
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                alert('請填寫所有必填的攜眷資料');
                return false;
            }
            
            // 檢查 email 是否重複
            const mainEmail = document.querySelector('input[name="email"]').value.toLowerCase().trim();
            const spouseEmail = document.querySelector('input[name="spouseEmail"]').value.toLowerCase().trim();
            
            if (mainEmail && spouseEmail && mainEmail === spouseEmail) {
                alert('主要申請人和攜眷的電郵地址不能相同');
                return false;
            }
        }
    }
    
    // 使用 AJAX 提交
    submitButton.disabled = true;
    submitButton.textContent = '提交中...';
    
    try {
        // 將 FormData 轉換為 URLSearchParams 以確保正確的 Content-Type
        const formDataObj = new FormData(form);
        const params = new URLSearchParams();
        for (const [key, value] of formDataObj.entries()) {
            params.append(key, value);
        }
        
        const response = await fetch(form.action, {
            method: 'POST',
            body: params,
            headers: {
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 成功：跳轉到成功頁面
            window.location.href = '/success';
        } else {
            // 錯誤：顯示錯誤訊息
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6';
            errorDiv.innerHTML = (data.error || '提交失敗，請檢查所有必填欄位').replace(/\n/g, '<br>');
            form.insertBefore(errorDiv, form.firstChild);
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    } catch (error) {
        console.error('提交錯誤:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6';
        errorDiv.textContent = '提交失敗，請稍後再試 Submission failed, please try again later.';
        form.insertBefore(errorDiv, form.firstChild);
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
    }
});
</script>
</body>
</html>
